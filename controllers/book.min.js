const Book=require("../models/Book"),fs=require("fs");exports.createBook=(req,res,next)=>{const bookObject=JSON.parse(req.body.book);delete bookObject._id,delete bookObject._userId,delete bookObject.averageRating;new Book({...bookObject,userId:req.auth.userId,averageRating:0,imageUrl:`${req.protocol}://${req.get("host")}/images/${req.file.filename}`}).save().then((()=>{res.status(201).json({message:"book enregistré !"})})).catch((error=>{res.status(400).json({error:error})}))},exports.getAllBooks=(req,res,next)=>{Book.find().then((books=>{res.status(200).json(books)})).catch((error=>res.status(400).json({error:error})))},exports.getOneBook=(req,res,next)=>{Book.findOne({_id:req.params.id}).then((book=>res.status(200).json(book))).catch((error=>res.status(404).json({error:error})))},exports.getBestBooks=(req,res,next)=>{Book.find({}).sort({averageRating:-1}).limit(3).then((books=>{res.status(200).json(books)})).catch((error=>res.status(500).json({error:error})))},exports.updateBook=(req,res,next)=>{const bookObject=req.file?{...JSON.parse(req.body.book),imageUrl:`${req.protocol}://${req.get("host")}/images/${req.file.filename}`}:{...req.body};delete bookObject._userId,Book.findOne({_id:req.params.id}).then((book=>{book.userId!=req.auth.userId?res.status(401).json({message:"Not authorized"}):Book.updateOne({_id:req.params.id},{...bookObject,_id:req.params.id}).then((()=>res.status(200).json({message:"Objet modifié!"}))).catch((error=>res.status(401).json({error:error})))})).catch((error=>{res.status(400).json({error:error})}))},exports.deleteBook=(req,res,next)=>{Book.findOne({_id:req.params.id}).then((book=>{if(book.userId!=req.auth.userId)res.status(401).json({message:"Non authorised"});else{const filename=book.imageUrl.split("/images/")[1];fs.unlink(`images/${filename}`,(()=>{Book.deleteOne({_id:req.params.id}).then((()=>{res.status(200).json({message:"Livre supprimé !"})})).catch((error=>res.status(401).json({error:error})))}))}})).catch((error=>res.status(500).json({error:error}))),Book.deleteOne({_id:req.params.id}).then((()=>res.status(200).json({message:"Livre supprimé !"}))).catch((error=>res.status(400).json({error:error})))},exports.rateBook=(req,res,next)=>{Book.findOne({_id:req.params.id,"ratings.userId":req.auth.userId}).then((ratedBook=>{if(ratedBook)return res.status(400).json({message:"Livre deja note par cet utilisateur"});Book.updateOne({_id:req.params.id},{$push:{ratings:{userId:req.auth.userId,grade:req.body.rating}}}).then((book=>{res.status(200).json({book:book}),console.log("hahhahDisney")})).catch((error=>res.status(400).json({error:error}))),Book.find().then((books=>{books.map((async book=>{const grades=book.ratings.map((r=>r.grade)).filter(Boolean);book.averageRating=grades.length?grades.reduce(((a,b)=>a+b),0)/grades.length:0,console.log(book),await book.save()}))})).catch((error=>res.status(400).json({error:error})))})).catch((error=>res.status(400).json({error:error})))};